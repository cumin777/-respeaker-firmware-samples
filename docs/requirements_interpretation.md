# reSpeaker 穿戴式 AI 麦克风 — 需求解读（固件/SDK 视角）

来源：`document/reSpeaker穿戴式AI麦克风产品需求书.docx`（已抽取文本）。

## 1. 产品定位（我们在做什么）
- **形态**：可穿戴/可夹/可磁吸/可挂绳的便携录音与“对话整理”设备，偏 2B，可贴牌/可定制。
- **核心价值**：离线独立录音存档 + 后续同步到手机/云端做转写、总结、待办、检索问答。
- **差异化**：更开放（可接入自定义 STT/LLM token，设备与平台解耦，提供二开 SDK）。

## 2. 硬件关键约束（影响固件架构）
- **SoC/无线**：nRF5340 + nRF7002（备选 nRF54L15 + nRF7002）。
- **音频输入**：2× PDM 麦克风；
  - 普通模式：双通道原始音频
  - 增强模式：降噪+增益后单通道
  - 采样率到 16 kHz（文档写 16Khz）。
- **显示**：0.5" 88×48 OLED（或备选 0.96"/AMOLED）。
- **存储**：32G。
- **交互**：单交互键（短按/长按/双击）+ 物理静音拨片 + 震动马达。
- **续航/低功耗**：增强模式 10 小时录音；普通模式 18 小时录音（对电源/无线策略约束极强）。
- **充电/升级**：4pin 磁吸/Type‑C；固件升级可走此接口（“自带 j-link”——需澄清实现形态）。

## 3. 出货固件：功能拆解（按模块落地）
### 3.1 设备状态机（强制要求）
需求明确要定义：待机 / 录音中 / 传输中 / 升级中 / 故障。
- 建议在固件建立 **统一 State Machine**：
  - 进入/退出动作：屏幕/震动/无线/文件系统一致性
  - 禁止状态：例如录音中不允许 OTA；OTA 前要求待机+充电

### 3.2 交互与 UI（屏幕 + 震动 + 按键 + 静音拨片）
- **首次开机**：长按 2s 开机 → 长震一次 → logo 动画 → 显示 App 二维码 60s。
- **信息页**：电量/充电、无线状态（未连接/已连接/蓝牙传输/Wi‑Fi 传输）、录制模式、未传输文件图标、装饰图案。
- **录音控制**：
  - 长按 1s 开始录音：震动 1 次；录音中显示音量柱动画，5s 后变圆点
  - 录音中长按 1s 停止：震动 2 次；回信息页
  - 录音中短按：重点标注（写时间戳），短震一次
- **模式切换**：未录制状态双击切换 普通/增强，短震一次。
- **静音拨片**：切换短震；
  - 录音中静音：UI 变红（音量柱/圆点渐变）
  - 待机静音：显示静音图标

### 3.3 音频采集与处理
- PDM→PCM 采集（16kHz/8kHz 可配置），双通道输入。
- 增强模式：必须有降噪、增益（算法可迭代，但接口要稳定）。
- 文件封装：需要定义 **命名规则 + 元数据**（时间戳、时长、标记点）。

### 3.4 存储与文件管理
- 文件系统：LittleFS 或 FATFS。
- 功能：录音文件写入、列表、删除；传输完成后自动删除；空间监控/格式化。
- 策略：自动清理旧文件（避免满盘导致录音失败）。

### 3.5 无线与传输
- **蓝牙**：配对、状态同步、低速文件传输、OTA。
- **Wi‑Fi**：用于高速导出录音；并要求支持 STA/AP、HTTP/HTTPS/MQTT、Socket、WebSocket、mDNS。
- **配网**：要求 “AP + BLE 辅助 / 自定义配网协议接入”。
- **文件传输协议**：必须支持 分片上传、断点续传、MD5 校验、进度回调。

### 3.6 OTA
- 通过 BLE + SenseCraft App OTA。
- OTA 前置条件：待机 + 充电。
- 文档还要求：BLE/USB OTA + 安全校验 + 回滚机制（需要选型：MCUboot/自研）。

### 3.7 日志与可维护性
- 多级别日志（UART/RTT）；错误日志落 Flash。

## 4. 二开 SDK（固件层 + App 层）解读
### 4.1 固件层 SDK（对外“能力边界”）
文档列了 22 类接口，核心是：
- 硬件抽象：麦克风、屏幕（基础绘图）、按键事件、马达、电源
- 音频处理：采集回调、预处理（降噪/增益）
- 存储：FS 读写、命名、元数据、清理策略
- 无线：BLE 管理 + 可扩展 GATT、自定义服务；Wi‑Fi STA/AP；网络协议封装；文件传输组件
- 框架：状态机、OTA（含回滚）、配置 KV、日志

### 4.2 App 层 SDK
- iOS（Swift）/Android（Kotlin）/Python：扫描、配对、配网、传输模式切换（BLE↔Wi‑Fi）、录音控制、状态同步、文件管理、OTA。
- 这是“平台解耦”的关键：固件要把协议边界设计成 **稳定可版本化** 的 API。

## 5. 与云端/APP 的关键耦合点（固件需要配合的）
- 设备注册/ID/SN/MAC/固件版本上报（如果走云，固件需提供可读标识）。
- 文件元数据：录制时间、时长、模式、校验和、标记点。
- 传输：默认 BLE 自动传未传文件；可切换 Wi‑Fi（设备开热点 + 手机加入）并支持断点续传。
- STT/LLM：由 App 配置第三方服务（固件侧无需承载 token，但要保证音频/元数据可用）。

## 6. 风险与需要澄清的问题（建议尽快关单）
- “增强模式降噪/增益”算法指标与资源预算（CPU/RAM/功耗）未量化。
- Wi‑Fi 传输拓扑：
  - 手机连设备 AP 传输 vs 设备 STA 上同一 LAN 传输（文档两者都暗示了）。
- 32G 存储与文件系统选择（FATFS 对大容量友好；LittleFS 可靠但实现差异）。
- USB/4pin “自带 j-link” 的量产形态（是做成 CMSIS-DAP/J-Link OB？还是仅保留调试口？）。
- 安全：BLE 配对方式、固件签名、回滚策略、Wi‑Fi 凭据存储（NVS/PSA）。

## 7. 建议的固件仓库模块划分（便于你在 NCS/Zephyr 落地）
- `app/`：产品状态机 + UI/交互 + 业务逻辑
- `drivers/` 或 `custom_driver_module/`：OLED、PDM、马达、静音拨片等
- `subsys/audio/`：采集 + 预处理接口
- `subsys/storage/`：文件系统 + 元数据 + 清理策略
- `subsys/ble/`：GATT 服务（状态/控制/文件/OTA）
- `subsys/wifi/`：配网（BLE 辅助）+ AP/STA 管理 + 传输协议
- `subsys/ota/`：MCUboot/镜像管理 + 回滚
- `subsys/config/`：NVS KV
- `subsys/log/`：日志/故障转储
